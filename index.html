<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯•</title>
    <style>
        /* é»˜è®¤äº®è‰²æ¨¡å¼æ ·å¼ */
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #dee2e6;
            --card-bg: #f8f9fa;
            --button-bg: #007bff;
            --button-text: #ffffff;
            --input-bg: #ffffff;
            --input-border: #ced4da;
            --chat-bg: #ffffff;
            --chat-border: #ccc;
            --highlight-bg: #f0f0f0;
            --host-bg: #ffc107;
            --host-text: #000000;
            --kick-button-bg: #dc3545;
            --kick-button-text: #ffffff;
        }

        /* æš—é»‘æ¨¡å¼æ ·å¼ */
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --border-color: #404040;
            --card-bg: #2d2d2d;
            --button-bg: #007bff;
            --button-text: #ffffff;
            --input-bg: #333333;
            --input-border: #555555;
            --chat-bg: #2d2d2d;
            --chat-border: #555555;
            --highlight-bg: #404040;
            --host-bg: #ffc107;
            --host-text: #000000;
            --kick-button-bg: #dc3545;
            --kick-button-text: #ffffff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        /* æš—é»‘æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1000;
            transition: background-color 0.3s;
        }

        .theme-toggle:hover {
            opacity: 0.8;
        }

        /* é€šç”¨æ ·å¼ */
        h2, h3 {
            color: var(--text-color);
        }

        input[type="text"], textarea {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            padding: 8px;
            border-radius: 4px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--button-bg);
        }

        button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        button:hover {
            opacity: 0.8;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* èŠå¤©åŒºåŸŸæ ·å¼ */
        #chatMessages {
            background-color: var(--chat-bg);
            border: 1px solid var(--chat-border);
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }

        /* é«˜äº®åŒºåŸŸæ ·å¼ */
        .highlight {
            background-color: var(--highlight-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        /* ç©å®¶åˆ—è¡¨æ ·å¼ */
        #players p {
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
        }

        /* æè¿°åˆ—è¡¨æ ·å¼ */
        #descriptions p {
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
        }

        /* æŠ•ç¥¨é€‰é¡¹æ ·å¼ */
        #voteOptions button {
            margin: 5px;
            display: block;
            width: 100%;
            text-align: left;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--card-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-color);
        }
    </style>
</head>
<body>
    <!-- æš—é»‘æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
        ğŸŒ™ æš—é»‘æ¨¡å¼
    </button>

    <div id="login">
        <h2>æµ‹è¯•1</h2>
        <div id="loginStatus">
            <p>è¯·å…ˆç™»å½•æ‘¸é±¼æ´¾è´¦å·</p>
            <button onclick="loginWithFishpi()">ç™»å½•æ´¾</button>
        </div>
        <div id="userInfo" style="display: none;">
            <p>æ¬¢è¿ï¼Œ<span id="userNickname"></span>ï¼</p>
            <div style="margin: 10px 0;">
                <input type="text" id="customRoomId" placeholder="è‡ªå®šä¹‰æˆ¿é—´IDï¼ˆå¯é€‰ï¼‰" style="margin-right: 5px;">
                <button onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
                <div style="font-size: 12px; color: var(--text-color); opacity: 0.7; margin-top: 5px;">
                    æˆ¿é—´IDæ ¼å¼ï¼š1-20ä¸ªå­—ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦
                </div>
            </div>
            <div style="margin: 10px 0;">
                <input type="text" id="roomId" placeholder="æˆ¿é—´IDï¼ˆå¯é€‰ï¼‰">
                <button onclick="joinGame()">åŠ å…¥æ¸¸æˆ</button>
            </div>
            <button onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
        <div id="roomList" style="margin-top: 20px;"></div>
    </div>

    <div id="gameRoom" style="display: none;">
        <h2>æˆ¿é—´</h2>
        <div id="roomInfo"></div>
        <div id="players"></div>
        <div id="gameStatus"></div>
        <div id="gameContent"></div>
        <div id="descriptions"></div>
        <div id="voteSection" style="display: none;">
            <h3>æŠ•ç¥¨</h3>
            <div id="voteOptions"></div>
        </div>
        <button onclick="leaveGame()">ç¦»å¼€</button>
    </div>

    <script>
        let ws = null;
        let playerId = null;
        let currentState = null;
        let gameData = null;
        let countdownTimer = null;
        let countdownStartTime = null;
        let userSessionId = null;
        let userInfo = null;
        let lastGameResult = null; // ä¿å­˜ä¸Šä¸€å±€æ¸¸æˆç»“æœ
        let isRefreshingRoomList = false; // é˜²æ­¢é‡å¤åˆ·æ–°æˆ¿é—´åˆ—è¡¨çš„æ ‡å¿—

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            // åˆå§‹åŒ–æš—é»‘æ¨¡å¼
            initTheme();
            
            // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰session_idï¼ˆç™»å½•å›è°ƒï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            
            if (sessionId) {
                // ä»URLå‚æ•°è·å–åˆ°session_idï¼Œä¿å­˜åˆ°localStorage
                localStorage.setItem('fishpi_session_id', sessionId);
                // æ¸…é™¤URLå‚æ•°
                window.history.replaceState({}, document.title, window.location.pathname);
                // éªŒè¯ä¼šè¯
                validateSession(sessionId);
            } else {
                // æ£€æŸ¥localStorageä¸­çš„session_id
                checkLoginStatus();
            }
            // èŠå¤©è¾“å…¥æ¡†å›è½¦å‘é€
            document.addEventListener('keydown', function(e) {
                const chatInput = document.getElementById('chatInput');
                if (chatInput && chatInput === document.activeElement && e.key === 'Enter') {
                    e.preventDefault();
                    sendChat();
                }
            });
        };

        // æš—é»‘æ¨¡å¼ç›¸å…³å‡½æ•°
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeButton(savedTheme);
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
        }

        function updateThemeButton(theme) {
            const button = document.getElementById('themeToggle');
            if (theme === 'dark') {
                button.innerHTML = 'â˜€ï¸ äº®è‰²æ¨¡å¼';
            } else {
                button.innerHTML = 'ğŸŒ™ æš—é»‘æ¨¡å¼';
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const sessionId = localStorage.getItem('fishpi_session_id');
            if (sessionId) {
                userSessionId = sessionId;
                // éªŒè¯ä¼šè¯æ˜¯å¦æœ‰æ•ˆ
                validateSession(sessionId);
            } else {
                showLoginPrompt();
            }
        }

        // æ˜¾ç¤ºç™»å½•æç¤º
        function showLoginPrompt() {
            document.getElementById('loginStatus').style.display = 'block';
            document.getElementById('userInfo').style.display = 'none';
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function showUserInfo(user) {
            userInfo = user;
            // ä½¿ç”¨nicknameå­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨username
            const displayName = user.nickname || user.username;
            document.getElementById('userNickname').textContent = displayName;
            document.getElementById('loginStatus').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            
            // ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œä¸»åŠ¨è·å–æˆ¿é—´åˆ—è¡¨
            fetchRoomList();
        }

        // è·å–æˆ¿é—´åˆ—è¡¨
        function fetchRoomList() {
            if (!userSessionId) {
                console.log('æœªç™»å½•ï¼Œæ— æ³•è·å–æˆ¿é—´åˆ—è¡¨');
                return;
            }
            
            // é˜²æ­¢é‡å¤åˆ·æ–°
            if (isRefreshingRoomList) {
                console.log('æˆ¿é—´åˆ—è¡¨æ­£åœ¨åˆ·æ–°ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
                return;
            }
            
            isRefreshingRoomList = true;
            console.log('è·å–æˆ¿é—´åˆ—è¡¨...');
            fetch(`/rooms/status?session_id=${userSessionId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('æˆ¿é—´åˆ—è¡¨APIå“åº”:', data);
                    if (data.success && data.rooms) {
                        updateRoomList(data.rooms);
                    } else {
                        console.error('è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥:', data.message || 'æœªçŸ¥é”™è¯¯');
                    }
                })
                .catch(error => {
                    console.error('è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥:', error);
                    // å¦‚æœAPIè·å–å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    const roomList = document.getElementById('roomList');
                    roomList.innerHTML = '<p>è·å–æˆ¿é—´åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
                })
                .finally(() => {
                    // å»¶è¿Ÿé‡ç½®æ ‡å¿—ï¼Œé˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤è°ƒç”¨
                    setTimeout(() => {
                        isRefreshingRoomList = false;
                    }, 1000);
                });
        }

        // ç™»å½•æ‘¸é±¼æ´¾
        function loginWithFishpi() {
            // è¯·æ±‚æˆ‘ä»¬çš„åç«¯ç”Ÿæˆç™»å½•URL
            fetch('/auth/login')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.login_url) {
                        console.log('è·å–åˆ°ç™»å½•URL:', data.login_url);
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ngrokè­¦å‘Šé¡µé¢
                        if (window.location.href.includes('ngrok-free.app') && document.title.includes('ngrok')) {
                            // å¦‚æœæ˜¯ngrokè­¦å‘Šé¡µé¢ï¼Œæ˜¾ç¤ºæç¤º
                            alert('æ£€æµ‹åˆ°ngrokè­¦å‘Šé¡µé¢ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»"Visit Site"æŒ‰é’®ç»§ç»­');
                        }
                        window.location.href = data.login_url;
                    } else {
                        console.error('è·å–ç™»å½•URLå¤±è´¥:', data.error);
                        alert('è·å–ç™»å½•URLå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('è¯·æ±‚ç™»å½•URLå¤±è´¥:', error);
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ngrokè­¦å‘Šé¡µé¢
                    if (window.location.href.includes('ngrok-free.app') && document.title.includes('ngrok')) {
                        alert('æ£€æµ‹åˆ°ngrokè­¦å‘Šé¡µé¢ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»"Visit Site"æŒ‰é’®ç»§ç»­');
                    } else {
                        alert('è¯·æ±‚ç™»å½•URLå¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });
        }

        // éªŒè¯ä¼šè¯
        function validateSession(sessionId) {
            fetch(`/auth/validate?session_id=${sessionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.user) {
                        userSessionId = sessionId; // è®¾ç½®ä¼šè¯ID
                        showUserInfo(data.user);
                    } else {
                        localStorage.removeItem('fishpi_session_id');
                        userSessionId = null; // æ¸…é™¤ä¼šè¯ID
                        showLoginPrompt();
                        if (data.message) {
                            alert('ä¼šè¯éªŒè¯å¤±è´¥: ' + data.message);
                        }
                    }
                })
                .catch(error => {
                    console.error('éªŒè¯ä¼šè¯å¤±è´¥:', error);
                    localStorage.removeItem('fishpi_session_id');
                    userSessionId = null; // æ¸…é™¤ä¼šè¯ID
                    showLoginPrompt();
                    alert('éªŒè¯ä¼šè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                });
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('fishpi_session_id');
            userSessionId = null;
            userInfo = null;
            showLoginPrompt();
        }

        function generateWebSocketUrl(endpoint = '/ws') {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            return `${protocol}//${host}${endpoint}`;
            //return `ws://127.0.0.1:8990/ws`;
        }

        function joinGame() {
            if (!userSessionId) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const roomId = document.getElementById('roomId').value;
            
            connectToWebSocket(null, roomId);
        }
        

        function connectToWebSocket(wsConfig, roomId) {
            // ä½¿ç”¨æ–°å‡½æ•°ç”ŸæˆWebSocketåœ°å€
            let wsUrl = generateWebSocketUrl('/ws');
            
            const params = new URLSearchParams();
            if (roomId) {
                params.append('room_id', roomId);
            }
            params.append('session_id', userSessionId);
            
            if (params.toString()) {
                wsUrl += `?${params.toString()}`;
            }
            
            console.log('å°è¯•è¿æ¥WebSocket:', wsUrl);
            
            try {
                // å¼ºåˆ¶ä½¿ç”¨WSåè®®ï¼Œå¿½ç•¥æ··åˆå†…å®¹è­¦å‘Š
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                    console.log('è¿æ¥çŠ¶æ€:', ws.readyState);
                    console.log('ç­‰å¾…æœåŠ¡å™¨å‘é€user_infoæ¶ˆæ¯...');
                    // è¿æ¥å»ºç«‹åï¼Œç­‰å¾…æœåŠ¡å™¨å‘é€user_infoæ¶ˆæ¯
                    // joinæ¶ˆæ¯å°†åœ¨æ”¶åˆ°user_infoåå‘é€
                };

                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (error) {
                        console.error('è§£ææ¶ˆæ¯å¤±è´¥:', error);
                        console.error('åŸå§‹æ¶ˆæ¯å†…å®¹:', event.data);
                    }
                };

                ws.onclose = (event) => {
                    console.log('WebSocketè¿æ¥å·²å…³é—­', event.code, event.reason);
                    console.log('å…³é—­åŸå› :', event.reason || 'æœªçŸ¥');
                    resetGame();
                };

                ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error);
                    // ä¸ç«‹å³æ˜¾ç¤ºé”™è¯¯ï¼Œè®©oncloseå¤„ç†
                };
            } catch (error) {
                console.error('åˆ›å»ºWebSocketè¿æ¥å¤±è´¥:', error);
                alert('åˆ›å»ºè¿æ¥å¤±è´¥: ' + error.message);
            }
        }

        function handleMessage(message) {
            try {
                
                switch (message.type) {
                    case 'user_info':
                        console.log('å¤„ç†ç”¨æˆ·ä¿¡æ¯æ¶ˆæ¯');
                        userInfo = message.data;
                        playerId = message.data.user_id;
                        console.log('è®¾ç½®ç©å®¶IDä¸º:', playerId);
                        
                        // æ”¶åˆ°ç”¨æˆ·ä¿¡æ¯åï¼Œå¦‚æœæœ‰æˆ¿é—´IDï¼Œå‘é€joinæ¶ˆæ¯åŠ å…¥æˆ¿é—´
                        const roomId = document.getElementById('roomId').value;
                        if (roomId && ws && ws.readyState === WebSocket.OPEN) {
                            const playerName = userInfo.nickname || userInfo.username;
                            console.log('å‘é€joinæ¶ˆæ¯:', { player_name: playerName, player_id: userInfo.user_id });
                            ws.send(JSON.stringify({
                                type: 'join',
                                data: {
                                    player_name: playerName,
                                    player_id: userInfo.user_id
                                }
                            }));
                        }
                        break;
                    case 'notification':
                        console.log('å¤„ç†é€šçŸ¥æ¶ˆæ¯');
                        showNotification(message.data.message);
                        
                        // å¤„ç†æè¿°åˆ—è¡¨
                        if (message.data.descriptions) {
                            console.log('æ”¶åˆ°æè¿°åˆ—è¡¨:', message.data.descriptions);
                            showDescriptions(message.data.descriptions);
                        }
                        break;
                    case 'descriptions_update':
                        console.log('å¤„ç†æè¿°åˆ—è¡¨æ›´æ–°æ¶ˆæ¯');
                        if (message.data.descriptions) {
                            console.log('æ”¶åˆ°æè¿°åˆ—è¡¨æ›´æ–°:', message.data.descriptions);
                            showDescriptions(message.data.descriptions);
                        }
                        break;
                    case 'state_update':
                        console.log('å¤„ç†çŠ¶æ€æ›´æ–°æ¶ˆæ¯');
                        console.log('å½“å‰ç©å®¶ID:', playerId);
                        console.log('æ¶ˆæ¯ä¸­çš„ç©å®¶åˆ—è¡¨:', message.data.players);
                        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ”¶åˆ°state_updateï¼Œè¯´æ˜æˆåŠŸåŠ å…¥æˆ¿é—´
                        if (!playerId && userInfo) {
                            console.log('é¦–æ¬¡æ”¶åˆ°çŠ¶æ€æ›´æ–°ï¼Œè®¾ç½®ç©å®¶ID');
                            document.getElementById('login').style.display = 'none';
                            document.getElementById('gameRoom').style.display = 'block';
                            playerId = userInfo.user_id;
                            console.log('è®¾ç½®ç©å®¶IDä¸º:', playerId);
                        }
                        updateGameState(message.data);
                        break;
                    case 'error':
                        console.log('å¤„ç†é”™è¯¯æ¶ˆæ¯');
                        const errorMessage = message.data.message || message.data.code || 'æœªçŸ¥é”™è¯¯';
                        showError(errorMessage);
                        break;
                    case 'description':
                        console.log('å¤„ç†æè¿°æ¶ˆæ¯');
                        showDescription(message.data);
                        break;
                    case 'vote':
                        console.log('å¤„ç†æŠ•ç¥¨æ¶ˆæ¯');
                        showVote(message.data);
                        break;
                    case 'chat':
                        console.log('å¤„ç†èŠå¤©æ¶ˆæ¯');
                        showChatMessage(message.data);
                        break;
                    case 'eliminated_chat':
                        console.log('å¤„ç†è¢«æ·˜æ±°ç©å®¶èŠå¤©æ¶ˆæ¯');
                        showEliminatedChatMessage(message.data);
                        break;
                    case 'countdown':
                        handleCountdownUpdate(message.data.seconds);
                        break;
                    case 'kicked':
                        console.log('å¤„ç†è¢«è¸¢å‡ºæ¶ˆæ¯');
                        showNotification(message.data.message);
                        // è¢«è¸¢å‡ºæˆ¿é—´ï¼Œè¿”å›å¤§å…
                        setTimeout(() => {
                            alert('æ‚¨å·²è¢«è¸¢å‡ºæˆ¿é—´');
                            leaveGame();
                        }, 1000);
                        break;
                    case 'kicked_from_other_room':
                        console.log('å¤„ç†ä»å…¶ä»–æˆ¿é—´è¸¢å‡ºæ¶ˆæ¯');
                        showNotification(message.data.message);
                        // è¢«ä»å…¶ä»–æˆ¿é—´è¸¢å‡ºï¼Œå…³é—­è¿æ¥å¹¶è¿”å›å¤§å…
                        setTimeout(() => {
                            alert('æ‚¨å·²åŠ å…¥å…¶ä»–æˆ¿é—´ï¼Œå·²ä»å½“å‰æˆ¿é—´æ–­å¼€è¿æ¥');
                            leaveGame();
                        }, 1000);
                        break;
                    default:
                        console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
                }
            } catch (error) {
                console.error('å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                showError('å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™');
            }
        }

        function showNotification(message) {
            console.log('æ˜¾ç¤ºé€šçŸ¥:', message);
            const gameStatus = document.getElementById('gameStatus');
            gameStatus.innerHTML = `<p>${message}</p>`;
        }

        function updateGameState(data) {
            console.log('å¼€å§‹æ›´æ–°æ¸¸æˆçŠ¶æ€');
            console.log('æ¸¸æˆæ•°æ®:', data);
            gameData = data;
            currentState = data.state;
            console.log('å½“å‰çŠ¶æ€:', currentState);
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ”¶åˆ°state_updateï¼Œæ˜¾ç¤ºæ¸¸æˆç•Œé¢
            if (document.getElementById('gameRoom').style.display === 'none') {
                console.log('é¦–æ¬¡æ”¶åˆ°çŠ¶æ€æ›´æ–°ï¼Œæ˜¾ç¤ºæ¸¸æˆç•Œé¢');
                document.getElementById('login').style.display = 'none';
                document.getElementById('gameRoom').style.display = 'block';
                if (userInfo && !playerId) {
                    playerId = userInfo.user_id;
                    console.log('è®¾ç½®ç©å®¶IDä¸º:', playerId);
                }
            }
            
            // æ›´æ–°ç©å®¶åˆ—è¡¨
            console.log('æ›´æ–°ç©å®¶åˆ—è¡¨');
            updatePlayersList(data.players);
            
            // æ›´æ–°æ¸¸æˆå†…å®¹
            const gameContent = document.getElementById('gameContent');
            const roomInfo = document.getElementById('roomInfo');
            
            console.log('æ›´æ–°æˆ¿é—´ä¿¡æ¯');
            roomInfo.innerHTML = `<p>å½“å‰çŠ¶æ€ï¼š${getStateName(data.state)}</p>`;
            
            // å¦‚æœåœ¨å¤§å…çŠ¶æ€ï¼Œæ›´æ–°å‡†å¤‡æŒ‰é’®çŠ¶æ€
            if (currentState === 'Lobby') {
                const readyButton = document.querySelector('#gameContent button');
                if (readyButton && readyButton.textContent === 'å‡†å¤‡' || readyButton && readyButton.textContent === 'å·²å‡†å¤‡') {
                    // æ£€æŸ¥å½“å‰ç©å®¶æ˜¯å¦å·²ç»å‡†å¤‡
                    const lobbyPlayer = data.players.find(p => p.id === playerId);
                    const isReady = lobbyPlayer && lobbyPlayer.is_ready;
                    
                    if (isReady) {
                        readyButton.textContent = 'å–æ¶ˆå‡†å¤‡';
                        readyButton.disabled = false;
                    } else {
                        readyButton.textContent = 'å‡†å¤‡';
                        readyButton.disabled = false;
                    }
                }
            }
            
            console.log('æ ¹æ®çŠ¶æ€æ›´æ–°æ¸¸æˆå†…å®¹');
            updateGameContent(data);
        }

        function updateGameContent(data) {
            console.log('æ›´æ–°æ¸¸æˆå†…å®¹');
            console.log('æ¸¸æˆæ•°æ®:', data);
            const gameContent = document.getElementById('gameContent');
            const voteSection = document.getElementById('voteSection');

            // å¼ºåˆ¶æ¸…ç©ºå†…å®¹ï¼Œé˜²æ­¢UIå åŠ 
            gameContent.innerHTML = '';
            voteSection.innerHTML = '';
            voteSection.style.display = 'none';
            
            // åªåœ¨æ¸¸æˆçœŸæ­£å¼€å§‹æ—¶ï¼ˆè¿›å…¥DescribePhaseçŠ¶æ€ï¼‰æ‰æ¸…é™¤ä¸Šä¸€å±€ç»“æœ
            if (data.state === 'DescribePhase') {
                console.log('æ¸¸æˆçœŸæ­£å¼€å§‹ï¼Œæ¸…é™¤ä¸Šä¸€å±€ç»“æœ');
                lastGameResult = null;
            }
            
            // ä¸å†æ‰‹åŠ¨æ¸…é™¤å€’è®¡æ—¶ï¼Œè®©åç«¯æ§åˆ¶å€’è®¡æ—¶çš„æ˜¾ç¤ºå’Œéšè—
            
            // æ˜¾ç¤ºå½“å‰ç©å®¶çš„è¯è¯­ä¿¡æ¯ï¼ˆåœ¨æ‰€æœ‰æ¸¸æˆçŠ¶æ€ä¸­éƒ½æ˜¾ç¤ºï¼‰
            const myPlayer = data.players.find(p => p.id === playerId);
            let playerWordHtml = '';
            if (myPlayer && myPlayer.word && data.state !== 'Lobby') {
                playerWordHtml = `
                    <div style="background-color: var(--highlight-bg); padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid var(--border-color);">
                        <p><strong>ä½ çš„è¯è¯­ï¼š</strong>${myPlayer.word}</p>
                    </div>
                `;
            }
            
            switch (data.state) {
                case 'Lobby':
                    console.log('å¤§å…çŠ¶æ€');
                    // éšè—æŠ•ç¥¨åŒºåŸŸ
                    document.getElementById('voteSection').style.display = 'none';
                    
                    // æ£€æŸ¥å½“å‰ç©å®¶æ˜¯å¦å·²ç»å‡†å¤‡
                    const lobbyPlayer = data.players.find(p => p.id === playerId);
                    const isReady = lobbyPlayer && lobbyPlayer.is_ready;
                    
                    if (isReady) {
                        gameContent.innerHTML = '<button onclick="ready()">å–æ¶ˆå‡†å¤‡</button>';
                    } else {
                        gameContent.innerHTML = '<button onclick="ready()">å‡†å¤‡</button>';
                    }
                    
                    // å¦‚æœæœ‰ä¸Šä¸€å±€æ¸¸æˆç»“æœï¼Œæ˜¾ç¤ºä¸Šä¸€å±€ä¿¡æ¯
                    if (lastGameResult) {
                        const lastGameDiv = document.createElement('div');
                        lastGameDiv.style.cssText = 'background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 5px; padding: 15px; margin: 15px 0;';
                        const winnerText = lastGameResult.winner === 'Civilian' ? 'å¹³æ°‘' : lastGameResult.winner === 'Undercover' ? 'å§åº•' : lastGameResult.winner;
                        lastGameDiv.innerHTML = `
                            <h3 style="margin-top: 0; color: var(--text-color);">ä¸Šä¸€å±€æ¸¸æˆç»“æœ</h3>
                            <p><strong>è·èƒœæ–¹ï¼š</strong>${winnerText}</p>
                            <p><strong>æ‰€æœ‰ç©å®¶è§’è‰²å’Œè¯è¯­ï¼š</strong></p>
                            <div style="max-height: 200px; overflow-y: auto;">
                        `;
                        
                        lastGameResult.players.forEach(player => {
                            const role = player.role || 'æœªçŸ¥';
                            const word = player.word || 'æœªçŸ¥';
                            const status = player.is_alive ? 'å­˜æ´»' : 'å·²æ·˜æ±°';
                            const statusColor = player.is_alive ? 'green' : 'red';
                            lastGameDiv.innerHTML += `
                                <p style="margin: 5px 0; color: ${statusColor};">${player.name}: ${role} - è¯è¯­: ${word} (${status})</p>
                            `;
                        });
                        
                        lastGameDiv.innerHTML += '</div>';
                        gameContent.appendChild(lastGameDiv);
                    }
                    
                    // æ·»åŠ èŠå¤©åŒºåŸŸ
                    const lobbyChatDiv = document.createElement('div');
                    lobbyChatDiv.id = 'chatSection';
                    lobbyChatDiv.innerHTML = `
                        <h3>èŠå¤©åŒºåŸŸ</h3>
                        <div id="chatMessages" style="height: 200px; overflow-y: auto; border: 1px solid var(--chat-border); padding: 10px; margin: 10px 0;"></div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="chatInput" placeholder="è¾“å…¥èŠå¤©å†…å®¹..." style="flex: 1;">
                            <button onclick="sendChat()">å‘é€</button>
                        </div>
                    `;
                    gameContent.appendChild(lobbyChatDiv);
                    
                    // æ˜¾ç¤ºå†å²èŠå¤©æ¶ˆæ¯
                    if (data.chat_messages) {
                        showChatMessages(data.chat_messages);
                    }
                    
                    // ä¸ºè¢«æ·˜æ±°çš„ç©å®¶æ·»åŠ è¢«æ·˜æ±°èŠå¤©åŒº
                    addEliminatedChatSection(gameContent, data);
                    break;
                case 'RoleAssignment':
                    console.log('è§’è‰²åˆ†é…çŠ¶æ€');
                    // éšè—æŠ•ç¥¨åŒºåŸŸ
                    document.getElementById('voteSection').style.display = 'none';
                    gameContent.innerHTML = `
                        ${playerWordHtml}
                        <p>æ­£åœ¨åˆ†é…è§’è‰²...</p>
                    `;
                    break;
                case 'DescribePhase':
                    console.log('æè¿°é˜¶æ®µ');
                    // éšè—æŠ•ç¥¨åŒºåŸŸ
                    document.getElementById('voteSection').style.display = 'none';
                    const currentPlayer = data.current_player;
                    if (currentPlayer === playerId) {
                        console.log('å½“å‰ç©å®¶å›åˆ');
                        const player = data.players.find(p => p.id === playerId);
                        gameContent.innerHTML = `
                            ${playerWordHtml}
                            <div id="countdown">
                                <h3>æè¿°æ—¶é—´å‰©ä½™ï¼š<span id="countdown-display">--</span>ç§’</h3>
                            </div>
                            <p>ä½ çš„è¯è¯­æ˜¯ï¼š${player.word}</p>
                            <textarea id="description" placeholder="è¯·è¾“å…¥ä½ çš„æè¿°"></textarea>
                            <button onclick="submitDescription()">æäº¤æè¿°</button>
                        `;
                        // å€’è®¡æ—¶ç”±åç«¯æ§åˆ¶
                        startCountdown();
                    } else {
                        console.log('ç­‰å¾…å…¶ä»–ç©å®¶');
                        const currentPlayerName = data.players.find(p => p.id === currentPlayer)?.name || 'æœªçŸ¥ç©å®¶';
                        gameContent.innerHTML = `
                            ${playerWordHtml}
                            <div id="countdown">
                                <h3>ç­‰å¾…æè¿°æ—¶é—´å‰©ä½™ï¼š<span id="countdown-display">--</span>ç§’</h3>
                            </div>
                            <p>ç­‰å¾…ç©å®¶ ${currentPlayerName} æè¿°...</p>
                        `;
                        // å€’è®¡æ—¶ç”±åç«¯æ§åˆ¶
                        startCountdown();
                    }
                    showDescriptions(data.descriptions || []);
                    
                    // æ·»åŠ èŠå¤©åŒºåŸŸ
                    const describeChatDiv = document.createElement('div');
                    describeChatDiv.id = 'chatSection';
                    describeChatDiv.innerHTML = `
                        <h3 style="margin-top: 20px;">èŠå¤©åŒºåŸŸ</h3>
                        <div id="chatMessages" style="height: 150px; overflow-y: auto; border: 1px solid var(--chat-border); padding: 10px; margin-bottom: 10px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="chatInput" placeholder="è¾“å…¥èŠå¤©å†…å®¹..." style="flex: 1;">
                            <button onclick="sendChat()">å‘é€</button>
                        </div>
                    `;
                    gameContent.appendChild(describeChatDiv);
                    
                    // æ˜¾ç¤ºå†å²èŠå¤©æ¶ˆæ¯
                    if (data.chat_messages) {
                        showChatMessages(data.chat_messages);
                    }
                    
                    // ä¸ºè¢«æ·˜æ±°çš„ç©å®¶æ·»åŠ è¢«æ·˜æ±°èŠå¤©åŒº
                    addEliminatedChatSection(gameContent, data);
                    break;
                case 'VotePhase':
                    console.log('æŠ•ç¥¨é˜¶æ®µ');
                    // ç¡®ä¿voteSectionæœ‰æ­£ç¡®çš„ç»“æ„
                    voteSection.innerHTML = `
                        <h3>æŠ•ç¥¨</h3>
                        <div id="voteOptions"></div>
                    `;
                    
                    gameContent.innerHTML = playerWordHtml;
                    
                    showVoteSection(data.players);
                    showDescriptions(data.descriptions || []);
                    
                    // å¦‚æœæœ‰æŠ•ç¥¨ä¿¡æ¯ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€
                    if (data.votes && Array.isArray(data.votes)) {
                        const myVote = data.votes.find(vote => vote.player_id === playerId);
                        if (myVote) {
                            updateVoteButtons(myVote.target_id);
                        }
                    }
                    
                    // åœ¨æŠ•ç¥¨åŒºåŸŸæ·»åŠ å€’è®¡æ—¶
                    const voteCountdownDiv = document.createElement('div');
                    voteCountdownDiv.id = 'countdown';
                    voteCountdownDiv.innerHTML = '<h3>æŠ•ç¥¨æ—¶é—´å‰©ä½™ï¼š<span id="countdown-display">--</span>ç§’</h3>';
                    voteSection.insertBefore(voteCountdownDiv, voteSection.firstChild);
                    // å€’è®¡æ—¶ç”±åç«¯æ§åˆ¶
                    startCountdown();
                    
                    // æ·»åŠ èŠå¤©åŒºåŸŸ
                    const voteChatDiv = document.createElement('div');
                    voteChatDiv.id = 'chatSection';
                    voteChatDiv.innerHTML = `
                        <h3 style="margin-top: 20px;">èŠå¤©åŒºåŸŸ</h3>
                        <div id="chatMessages" style="height: 150px; overflow-y: auto; border: 1px solid var(--chat-border); padding: 10px; margin-bottom: 10px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="chatInput" placeholder="è¾“å…¥èŠå¤©å†…å®¹..." style="flex: 1;">
                            <button onclick="sendChat()">å‘é€</button>
                        </div>
                    `;
                    gameContent.appendChild(voteChatDiv);
                    
                    // æ˜¾ç¤ºå†å²èŠå¤©æ¶ˆæ¯
                    if (data.chat_messages) {
                        showChatMessages(data.chat_messages);
                    }
                    
                    // ä¸ºè¢«æ·˜æ±°çš„ç©å®¶æ·»åŠ è¢«æ·˜æ±°èŠå¤©åŒº
                    addEliminatedChatSection(gameContent, data);
                    break;
                case 'ResultPhase':
                    console.log('ç»“æœé˜¶æ®µ');
                    console.log('ç»“æœæ•°æ®:', data);
                    
                    // éšè—æŠ•ç¥¨åŒºåŸŸ
                    document.getElementById('voteSection').style.display = 'none';
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å¹³ç¥¨
                    let resultMessage = '';
                    if (!data.eliminated || data.eliminated === 'null' || data.eliminated === '00000000-0000-0000-0000-000000000000') {
                        resultMessage = 'æŠ•ç¥¨å¹³ç¥¨ï¼Œæ²¡æœ‰äººè¢«æ·˜æ±°ï¼';
                    } else {
                        // æ‰¾åˆ°è¢«æ·˜æ±°çš„ç©å®¶
                        const eliminatedPlayer = data.players.find(p => p.id === data.eliminated);
                        if (eliminatedPlayer) {
                            resultMessage = `ç©å®¶ ${eliminatedPlayer.name} è¢«æ·˜æ±°äº†ï¼`;
                        } else {
                            resultMessage = 'æœ‰ç©å®¶è¢«æ·˜æ±°äº†ï¼';
                        }
                    }
                    
                    gameContent.innerHTML = `
                        <div id="countdown">
                            <h3>ä¸‹ä¸€è½®å€’è®¡æ—¶ï¼š<span id="countdown-display">--</span>ç§’</h3>
                        </div>
                        ${playerWordHtml}
                        <h3>æŠ•ç¥¨ç»“æœ</h3>
                        <p>${resultMessage}</p>
                        <p>æ­£åœ¨è¿›å…¥ä¸‹ä¸€è½®...</p>
                    `;
                    // å€’è®¡æ—¶ç”±åç«¯æ§åˆ¶
                    startCountdown();
                    
                    // ä¸ºè¢«æ·˜æ±°çš„ç©å®¶æ·»åŠ è¢«æ·˜æ±°èŠå¤©åŒº
                    addEliminatedChatSection(gameContent, data);
                    break;
                case 'GameOver':
                    console.log('æ¸¸æˆç»“æŸ');
                    // éšè—æŠ•ç¥¨åŒºåŸŸ
                    document.getElementById('voteSection').style.display = 'none';
                    
                    const gameOverContent = document.getElementById('gameContent');
                    gameOverContent.innerHTML = ''; // æ¸…ç©ºå†…å®¹

                    const winner = data.winner || 'æœªçŸ¥';
                    const winnerText = winner === 'Civilian' ? 'å¹³æ°‘' : winner === 'Undercover' ? 'å§åº•' : winner;
                    
                    // ä¿å­˜ä¸Šä¸€å±€æ¸¸æˆç»“æœ
                    lastGameResult = {
                        winner: winner,
                        players: data.players
                    };
                    
                    gameOverContent.innerHTML += `
                        <h2>æ¸¸æˆç»“æŸï¼</h2>
                        <h3>è·èƒœæ–¹ï¼š${winnerText}</h3>
                        ${playerWordHtml}
                        <p>æ‰€æœ‰ç©å®¶è§’è‰²å’Œè¯è¯­ï¼š</p>
                        <div id="finalResults"></div>
                    `;
                    showFinalResults(data.players);

                    // æ·»åŠ "å†æ¥ä¸€å±€"æŒ‰é’®
                    const playAgainButton = document.createElement('button');
                    playAgainButton.textContent = 'å†æ¥ä¸€å±€';
                    playAgainButton.onclick = ready;
                    gameOverContent.appendChild(playAgainButton);
                    
                    // æ·»åŠ èŠå¤©åŒºåŸŸ
                    const gameOverChatDiv = document.createElement('div');
                    gameOverChatDiv.id = 'chatSection';
                    gameOverChatDiv.innerHTML = `
                        <h3 style="margin-top: 20px;">èŠå¤©åŒºåŸŸ</h3>
                        <div id="chatMessages" style="height: 150px; overflow-y: auto; border: 1px solid var(--chat-border); padding: 10px; margin-bottom: 10px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="chatInput" placeholder="è¾“å…¥èŠå¤©å†…å®¹..." style="flex: 1;">
                            <button onclick="sendChat()">å‘é€</button>
                        </div>
                    `;
                    gameOverContent.appendChild(gameOverChatDiv);
                    
                    // æ˜¾ç¤ºå†å²èŠå¤©æ¶ˆæ¯
                    if (data.chat_messages) {
                        showChatMessages(data.chat_messages);
                    }
                    
                    // ä¸ºè¢«æ·˜æ±°çš„ç©å®¶æ·»åŠ è¢«æ·˜æ±°èŠå¤©åŒº
                    addEliminatedChatSection(gameOverContent, data);
                    break;
            }
        }

        function updatePlayersList(players) {
            console.log('æ›´æ–°ç©å®¶åˆ—è¡¨');
            console.log('ç©å®¶æ•°æ®:', players);
            const playersDiv = document.getElementById('players');
            playersDiv.innerHTML = '<h3>ç©å®¶åˆ—è¡¨</h3>';
            
            // è·å–æˆ¿ä¸»ID
            const hostId = gameData.host;
            console.log('æˆ¿ä¸»ID:', hostId);
            
            players.forEach(player => {
                console.log('å¤„ç†ç©å®¶:', player);
                
                let status;
                let statusClass = '';

                if (currentState === 'Lobby') {
                    status = player.is_ready ? 'å‡†å¤‡' : 'æœªå‡†å¤‡';
                    statusClass = player.is_ready ? 'style="color: green;"' : 'style="color: gray;"';
                } else {
                    status = player.is_alive ? 'å­˜æ´»' : 'å·²æ·˜æ±°';
                    statusClass = player.is_alive ? '' : 'style="color: red;"';
                }

                // æ˜¾ç¤ºå½“å‰ç©å®¶çš„è§’è‰²å’Œè¯è¯­
                let playerInfo = '';
                if (player.id === playerId) {
                    if (player.role && player.word) {
                        playerInfo = ` (${player.role} - è¯è¯­: ${player.word})`;
                    } else if (player.role) {
                        playerInfo = ` (${player.role})`;
                    }
                }
                
                // æˆ¿ä¸»æ ‡è¯†
                let hostBadge = '';
                if (player.id === hostId) {
                    hostBadge = ' <span style="background-color: var(--host-bg); color: var(--host-text); padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-left: 5px;">æˆ¿ä¸»</span>';
                }
                
                // è¸¢äººæŒ‰é’®ï¼ˆåªæœ‰æˆ¿ä¸»å¯ä»¥çœ‹åˆ°ï¼Œä¸”ä¸èƒ½è¸¢è‡ªå·±ï¼‰
                let kickButton = '';
                if (currentState === 'Lobby' && playerId === hostId && player.id !== playerId) {
                    kickButton = ` <button onclick="kickPlayer('${player.id}', '${player.name}')" style="background-color: var(--kick-button-bg); color: var(--kick-button-text); border: none; padding: 2px 6px; border-radius: 3px; font-size: 12px; cursor: pointer; margin-left: 5px;">è¸¢å‡º</button>`;
                }
                
                playersDiv.innerHTML += `
                    <p ${statusClass}>${player.name}${hostBadge}${playerInfo} - ${status}${kickButton}</p>
                `;
            });
        }

        function showDescriptions(descriptions) {
            console.log('æ˜¾ç¤ºæè¿°åˆ—è¡¨');
            console.log('æè¿°æ•°æ®:', descriptions);
            const descriptionsDiv = document.getElementById('descriptions');
            
            // ç¡®ä¿descriptionsæ˜¯æ•°ç»„
            if (!Array.isArray(descriptions)) {
                console.log('descriptionsä¸æ˜¯æ•°ç»„ï¼Œå°è¯•è½¬æ¢');
                if (descriptions && typeof descriptions === 'object') {
                    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œè½¬æ¢ä¸ºæ•°ç»„
                    descriptions = Object.entries(descriptions).map(([player_id, content]) => ({
                        player_id,
                        content
                    }));
                } else {
                    descriptions = [];
                }
            }
            
            if (!descriptions || descriptions.length === 0) {
                console.log('æ²¡æœ‰æè¿°æ•°æ®');
                descriptionsDiv.innerHTML = '<p>æš‚æ— æè¿°</p>';
                return;
            }
            
            descriptionsDiv.innerHTML = '<h3>æè¿°åˆ—è¡¨</h3>';
            descriptions.forEach(desc => {
                const player = gameData.players.find(p => p.id === desc.player_id);
                const playerName = player ? player.name : 'æœªçŸ¥ç©å®¶';
                descriptionsDiv.innerHTML += `
                    <p>${playerName}: ${desc.content}</p>
                `;
            });
        }

        function showVoteSection(players) {
            // ä¸å†æ‰‹åŠ¨æ¸…é™¤å€’è®¡æ—¶ï¼Œè®©åç«¯æ§åˆ¶å€’è®¡æ—¶çš„æ˜¾ç¤ºå’Œéšè—
            
            const voteSection = document.getElementById('voteSection');
            voteSection.style.display = 'block';
            
            // ç¡®ä¿voteOptionså…ƒç´ å­˜åœ¨
            let voteOptions = document.getElementById('voteOptions');
            if (!voteOptions) {
                voteOptions = document.createElement('div');
                voteOptions.id = 'voteOptions';
                voteSection.appendChild(voteOptions);
            }
            
            voteOptions.innerHTML = '';
            const alivePlayers = players.filter(p => p.is_alive);
            console.log('å­˜æ´»ç©å®¶:', alivePlayers);
            
            alivePlayers.forEach(player => {
                if (player.id !== playerId) {
                    voteOptions.innerHTML += `
                        <button onclick="vote('${player.id}')" id="vote-${player.id}" data-target-id="${player.id}">æŠ•ç¥¨ç»™ ${player.name}</button>
                    `;
                }
            });
            
            if (alivePlayers.length <= 1) {
                voteOptions.innerHTML = '<p>æ²¡æœ‰å¯æŠ•ç¥¨çš„ç©å®¶</p>';
            }
            
            // ç¡®ä¿æ‰€æœ‰æŠ•ç¥¨æŒ‰é’®éƒ½æ˜¯å¯ç”¨çŠ¶æ€
            const voteButtons = document.querySelectorAll('#voteOptions button');
            voteButtons.forEach(button => {
                button.disabled = false;
                button.textContent = button.textContent.replace('å·²æŠ•ç¥¨', '').replace('æŠ•ç¥¨ç»™ ', 'æŠ•ç¥¨ç»™ ');
                button.style.backgroundColor = '';
                button.style.color = '';
            });
        }

        function showFinalResults(players) {
            const finalResults = document.getElementById('finalResults');
            finalResults.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            
            players.forEach(player => {
                const role = player.role || 'æœªçŸ¥';
                const word = player.word || 'æœªçŸ¥';
                const status = player.is_alive ? 'å­˜æ´»' : 'å·²æ·˜æ±°';
                const statusClass = player.is_alive ? 'style="color: green;"' : 'style="color: red;"';
                
                finalResults.innerHTML += `
                    <p ${statusClass}>${player.name}: ${role} - è¯è¯­: ${word} (${status})</p>
                `;
            });
        }

        function getStateName(state) {
            const stateNames = {
                'Lobby': 'ç­‰å¾…ä¸­',
                'RoleAssignment': 'åˆ†é…è§’è‰²',
                'DescribePhase': 'æè¿°é˜¶æ®µ',
                'VotePhase': 'æŠ•ç¥¨é˜¶æ®µ',
                'ResultPhase': 'ç»“æœé˜¶æ®µ',
                'GameOver': 'ç»“æŸ'
            };
            return stateNames[state] || state;
        }

        function ready() {
            if (!ws || !playerId) {
                console.error('WebSocketæœªè¿æ¥æˆ–ç©å®¶IDæœªè®¾ç½®');
                return;
            }
            console.log('å‘é€å‡†å¤‡æ¶ˆæ¯ï¼Œç©å®¶ID:', playerId);
            ws.send(JSON.stringify({
                type: 'ready',
                data: {
                    player_id: playerId
                }
            }));
        }

        function submitDescription() {
            if (!ws || !playerId) {
                console.error('WebSocketæœªè¿æ¥æˆ–ç©å®¶IDæœªè®¾ç½®');
                return;
            }
            const content = document.getElementById('description').value.trim();
            if (!content) {
                alert('è¯·è¾“å…¥æè¿°å†…å®¹');
                return;
            }
            console.log('å‘é€æè¿°æ¶ˆæ¯ï¼Œç©å®¶ID:', playerId, 'å†…å®¹:', content);
            ws.send(JSON.stringify({
                type: 'describe',
                data: {
                    player_id: playerId,
                    content: content
                }
            }));
        }

        function updateVoteButtons(currentVoteTargetId) {
            const voteButtons = document.querySelectorAll('#voteOptions button');
            voteButtons.forEach(button => {
                const targetId = button.getAttribute('data-target-id');
                if (targetId === currentVoteTargetId) {
                    button.disabled = true;
                    button.textContent = 'å·²æŠ•ç¥¨';
                    button.style.backgroundColor = '#4CAF50';
                    button.style.color = 'white';
                } else {
                    button.disabled = false;
                    button.textContent = button.textContent.replace('å·²æŠ•ç¥¨', '').replace('æŠ•ç¥¨ç»™ ', 'æŠ•ç¥¨ç»™ ');
                    button.style.backgroundColor = '';
                    button.style.color = '';
                }
            });
        }

        function vote(targetId) {
            if (!ws || !playerId) {
                console.error('WebSocketæœªè¿æ¥æˆ–ç©å®¶IDæœªè®¾ç½®');
                return;
            }
            console.log('å‘é€æŠ•ç¥¨æ¶ˆæ¯ï¼Œç©å®¶ID:', playerId, 'ç›®æ ‡ID:', targetId);
            
            // æ›´æ–°æŠ•ç¥¨æŒ‰é’®çŠ¶æ€
            updateVoteButtons(targetId);
            
            ws.send(JSON.stringify({
                type: 'vote',
                data: {
                    player_id: playerId,
                    target_id: targetId
                }
            }));
        }

        function leaveGame() {
            if (ws && playerId) {
                console.log('å‘é€ç¦»å¼€æ¶ˆæ¯ï¼Œç©å®¶ID:', playerId);
                ws.send(JSON.stringify({
                    type: 'leave',
                    data: {
                        player_id: playerId
                    }
                }));
            }
            if (ws) {
                ws.close();
            }
            resetGame();
        }

        function resetGame() {
            document.getElementById('login').style.display = 'block';
            document.getElementById('gameRoom').style.display = 'none';
            clearCountdown();
            ws = null;
            playerId = null;
            currentState = null;
            gameData = null;
            // ä¸æ¸…é™¤ä¸Šä¸€å±€ç»“æœä¿¡æ¯ï¼Œè®©ç©å®¶é‡æ–°åŠ å…¥æˆ¿é—´æ—¶è¿˜èƒ½çœ‹åˆ°
            
            // ç”¨æˆ·ç¦»å¼€æˆ¿é—´åï¼Œåˆ·æ–°æˆ¿é—´åˆ—è¡¨
            if (userSessionId) {
                console.log('ç”¨æˆ·ç¦»å¼€æˆ¿é—´ï¼Œåˆ·æ–°æˆ¿é—´åˆ—è¡¨');
                fetchRoomList();
            }
        }

        function showError(message) {
            alert(`é”™è¯¯ï¼š${message}`);
        }

        function updateRoomList(rooms) {
            console.log('æ›´æ–°æˆ¿é—´åˆ—è¡¨:', rooms);
            const roomList = document.getElementById('roomList');
            if (!rooms || rooms.length === 0) {
                roomList.innerHTML = '<p>å½“å‰æ²¡æœ‰å¯ç”¨çš„æˆ¿é—´</p>';
                return;
            }

            let html = '<h3>å¯ç”¨æˆ¿é—´åˆ—è¡¨</h3><ul>';
            let validRooms = 0;
            
            rooms.forEach((room, index) => {
                console.log(`æˆ¿é—´ ${index}:`, room);
                
                // æ£€æŸ¥æˆ¿é—´æ•°æ®æ˜¯å¦æœ‰æ•ˆ
                const roomId = room.room_id || room.id;
                const playerCount = room.player_count;
                const shouldBeDeleted = room.should_be_deleted;
                
                console.log(`æˆ¿é—´ ${index} è¯¦æƒ…:`, {
                    roomId,
                    playerCount,
                    shouldBeDeleted,
                    hasRoomId: !!roomId,
                    hasPlayerCount: typeof playerCount !== 'undefined'
                });
                
                // æ£€æŸ¥æˆ¿é—´æ˜¯å¦åº”è¯¥è¢«åˆ é™¤
                if (!shouldBeDeleted && roomId) {
                    validRooms++;
                    html += `
                        <li>
                            æˆ¿é—´ID: ${roomId} - ç©å®¶æ•°: ${playerCount || 0}
                            <button onclick="joinRoom('${roomId}')">åŠ å…¥æ­¤æˆ¿é—´</button>
                        </li>
                    `;
                }
            });
            
            html += '</ul>';
            
            if (validRooms === 0) {
                roomList.innerHTML = '<p>å½“å‰æ²¡æœ‰å¯ç”¨çš„æˆ¿é—´</p>';
            } else {
                roomList.innerHTML = html;
            }
            
            console.log(`æˆ¿é—´åˆ—è¡¨æ›´æ–°å®Œæˆï¼Œæœ‰æ•ˆæˆ¿é—´æ•°: ${validRooms}`);
        }

        function joinRoom(roomId) {
            document.getElementById('roomId').value = roomId;
            joinGame();
        }

        function showDescription(data) {
            const gameContent = document.getElementById('gameContent');
            const player = gameData.players.find(p => p.id === data.player_id);
            if (player) {
                gameContent.innerHTML += `<p>${player.name} çš„æè¿°: ${data.content}</p>`;
            }
        }

        function showVote(data) {
            const voteSection = document.getElementById('voteSection');
            const voteOptions = document.getElementById('voteOptions');
            voteSection.style.display = 'block';
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            voteOptions.innerHTML = '';
            
            // åªæ˜¾ç¤ºå­˜æ´»çš„ç©å®¶ä½œä¸ºæŠ•ç¥¨é€‰é¡¹
            const alivePlayers = gameData.players.filter(p => p.is_alive);
            console.log('å­˜æ´»ç©å®¶:', alivePlayers);
            
            alivePlayers.forEach(player => {
                if (player.id !== playerId) {
                    const button = document.createElement('button');
                    button.textContent = `æŠ•ç¥¨ç»™ ${player.name}`;
                    button.setAttribute('data-target-id', player.id);
                    button.onclick = () => vote(player.id);
                    voteOptions.appendChild(button);
                }
            });
            
            if (alivePlayers.length <= 1) {
                voteOptions.innerHTML = '<p>æ²¡æœ‰å¯æŠ•ç¥¨çš„ç©å®¶</p>';
            }
        }

        function handleCountdownUpdate(seconds) {
            const countdownDisplay = document.getElementById('countdown-display');
            if (countdownDisplay) {
                countdownDisplay.textContent = seconds;
                
                // å¦‚æœå€’è®¡æ—¶ç»“æŸï¼Œè‡ªåŠ¨æ¸…é™¤æ˜¾ç¤º
                if (seconds <= 0) {
                    // éšè—å€’è®¡æ—¶å…ƒç´ 
                    const countdownDiv = document.getElementById('countdown');
                    if (countdownDiv) {
                        countdownDiv.style.display = 'none';
                    }
                } else {
                    // ç¡®ä¿å€’è®¡æ—¶å…ƒç´ å¯è§
                    const countdownDiv = document.getElementById('countdown');
                    if (countdownDiv) {
                        countdownDiv.style.display = 'block';
                    }
                }
            }
        }

        // å¼€å§‹å€’è®¡æ—¶ï¼ˆç°åœ¨ä¸»è¦ç”¨äºåˆå§‹åŒ–æ˜¾ç¤ºï¼Œå®é™…å€’è®¡æ—¶ç”±åç«¯æ§åˆ¶ï¼‰
        function startCountdown() {
            const countdownDisplay = document.getElementById('countdown-display');
            
            if (!countdownDisplay) {
                console.error('æ‰¾ä¸åˆ°å€’è®¡æ—¶æ˜¾ç¤ºå…ƒç´ ');
                return;
            }
            
            // è®¾ç½®åˆå§‹æ˜¾ç¤ºå€¼ä¸ºå ä½ç¬¦
            countdownDisplay.textContent = '--';
            
            // ç¡®ä¿å€’è®¡æ—¶å…ƒç´ å¯è§
            const countdownDiv = document.getElementById('countdown');
            if (countdownDiv) {
                countdownDiv.style.display = 'block';
            }
            
            console.log('å€’è®¡æ—¶åˆå§‹åŒ–ï¼Œç­‰å¾…åç«¯æ›´æ–°');
            
            // ä¸å†ä½¿ç”¨å‰ç«¯å®šæ—¶å™¨ï¼Œæ”¹ä¸ºä¾èµ–åç«¯å‘é€çš„å€’è®¡æ—¶æ›´æ–°
            // ä¿ç•™countdownTimerå˜é‡ä»¥é˜²éœ€è¦æ‰‹åŠ¨æ¸…é™¤
            countdownTimer = null;
        }

        // æ¸…é™¤å€’è®¡æ—¶ï¼ˆä¸»è¦ç”¨äºæ¸¸æˆé‡ç½®ç­‰åœºæ™¯ï¼‰
        function clearCountdown() {
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            countdownStartTime = null;
            
            // éšè—å€’è®¡æ—¶å…ƒç´ 
            const countdownDiv = document.getElementById('countdown');
            if (countdownDiv) {
                countdownDiv.style.display = 'none';
            }
            
            // æ¸…é™¤å€’è®¡æ—¶æ˜¾ç¤º
            const countdownDisplay = document.getElementById('countdown-display');
            if (countdownDisplay) {
                countdownDisplay.textContent = '0';
            }
        }

        // å‘é€èŠå¤©æ¶ˆæ¯
        function sendChat() {
            if (!ws || !playerId) {
                console.error('WebSocketæœªè¿æ¥æˆ–ç©å®¶IDæœªè®¾ç½®');
                return;
            }
            const chatInput = document.getElementById('chatInput');
            const content = chatInput.value.trim();
            
            if (!content) {
                return;
            }
            
            console.log('å‘é€èŠå¤©æ¶ˆæ¯ï¼Œç©å®¶ID:', playerId, 'å†…å®¹:', content);
            ws.send(JSON.stringify({
                type: 'chat',
                data: {
                    player_id: playerId,
                    content: content
                }
            }));
            
            chatInput.value = '';
        }

        // å‘é€è¢«æ·˜æ±°ç©å®¶èŠå¤©æ¶ˆæ¯
        function sendEliminatedChat() {
            if (!ws || !playerId) {
                console.error('WebSocketæœªè¿æ¥æˆ–ç©å®¶IDæœªè®¾ç½®');
                return;
            }
            const eliminatedChatInput = document.getElementById('eliminatedChatInput');
            const content = eliminatedChatInput.value.trim();
            
            if (!content) {
                return;
            }
            
            console.log('å‘é€è¢«æ·˜æ±°èŠå¤©æ¶ˆæ¯ï¼Œç©å®¶ID:', playerId, 'å†…å®¹:', content);
            ws.send(JSON.stringify({
                type: 'eliminated_chat',
                data: {
                    player_id: playerId,
                    content: content
                }
            }));
            
            eliminatedChatInput.value = '';
        }

        // æ˜¾ç¤ºèŠå¤©æ¶ˆæ¯
        function showChatMessage(data) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '5px';
            messageDiv.innerHTML = `<strong>${data.player_name}:</strong> ${data.content}`;
            chatMessages.appendChild(messageDiv);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showEliminatedChatMessage(data) {
            const eliminatedChatMessages = document.getElementById('eliminatedChatMessages');
            if (!eliminatedChatMessages) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '5px';
            messageDiv.innerHTML = `<strong>${data.player_name}:</strong> ${data.content}`;
            eliminatedChatMessages.appendChild(messageDiv);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            eliminatedChatMessages.scrollTop = eliminatedChatMessages.scrollHeight;
        }

        // æ˜¾ç¤ºèŠå¤©æ¶ˆæ¯åˆ—è¡¨
        function showChatMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            chatMessages.innerHTML = '';
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.style.marginBottom = '5px';
                messageDiv.innerHTML = `<strong>${msg.player_name}:</strong> ${msg.content}`;
                chatMessages.appendChild(messageDiv);
            });
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ˜¾ç¤ºè¢«æ·˜æ±°ç©å®¶èŠå¤©æ¶ˆæ¯åˆ—è¡¨
        function showEliminatedChatMessages(messages) {
            const eliminatedChatMessages = document.getElementById('eliminatedChatMessages');
            if (!eliminatedChatMessages) return;
            
            eliminatedChatMessages.innerHTML = '';
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.style.marginBottom = '5px';
                messageDiv.innerHTML = `<strong>${msg.player_name}:</strong> ${msg.content}`;
                eliminatedChatMessages.appendChild(messageDiv);
            });
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            eliminatedChatMessages.scrollTop = eliminatedChatMessages.scrollHeight;
        }

        // éªŒè¯æˆ¿é—´IDæ ¼å¼
        function validateRoomId(roomId) {
            if (!roomId) return { valid: true, message: '' };
            
            if (roomId.length > 20) {
                return { valid: false, message: 'æˆ¿é—´IDé•¿åº¦ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦' };
            }
            
            if (!/^[a-zA-Z0-9_-]+$/.test(roomId)) {
                return { valid: false, message: 'æˆ¿é—´IDåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦' };
            }
            
            return { valid: true, message: '' };
        }

        // åˆ›å»ºæˆ¿é—´
        function createRoom() {
            if (!userSessionId) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            const customRoomId = document.getElementById('customRoomId').value.trim();
            
            // å‰ç«¯éªŒè¯æˆ¿é—´IDæ ¼å¼
            if (customRoomId) {
                const validation = validateRoomId(customRoomId);
                if (!validation.valid) {
                    alert('æˆ¿é—´IDæ ¼å¼é”™è¯¯: ' + validation.message);
                    return;
                }
            }
            
            console.log('åˆ›å»ºæˆ¿é—´...', customRoomId ? `è‡ªå®šä¹‰ID: ${customRoomId}` : 'è‡ªåŠ¨ç”ŸæˆID');
            
            // æ„å»ºè¯·æ±‚URL
            let url = `/rooms/create?session_id=${userSessionId}`;
            if (customRoomId) {
                url += `&room_id=${encodeURIComponent(customRoomId)}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('åˆ›å»ºæˆ¿é—´APIå“åº”:', data);
                    if (data.success && data.room_id) {
                        console.log('æˆ¿é—´åˆ›å»ºæˆåŠŸ:', data.room_id);
                        // è‡ªåŠ¨å¡«å…¥æˆ¿é—´IDå¹¶åŠ å…¥æ¸¸æˆ
                        document.getElementById('roomId').value = data.room_id;
                        // æ¸…ç©ºè‡ªå®šä¹‰æˆ¿é—´IDè¾“å…¥æ¡†
                        document.getElementById('customRoomId').value = '';
                        joinGame();
                    } else {
                        console.error('åˆ›å»ºæˆ¿é—´å¤±è´¥:', data.message || 'æœªçŸ¥é”™è¯¯');
                        alert('åˆ›å»ºæˆ¿é—´å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('åˆ›å»ºæˆ¿é—´è¯·æ±‚å¤±è´¥:', error);
                    alert('åˆ›å»ºæˆ¿é—´è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
        }

        // è¸¢äººå‡½æ•°
        function kickPlayer(targetId, targetName) {
            if (!ws || !playerId) {
                console.error('WebSocketæœªè¿æ¥æˆ–ç©å®¶IDæœªè®¾ç½®');
                return;
            }
            
            // ç¡®è®¤è¸¢äººæ“ä½œ
            if (!confirm(`ç¡®å®šè¦è¸¢å‡ºç©å®¶ ${targetName} å—ï¼Ÿ`)) {
                return;
            }
            
            console.log('å‘é€è¸¢äººæ¶ˆæ¯ï¼Œè¸¢äººè€…ID:', playerId, 'ç›®æ ‡ID:', targetId);
            ws.send(JSON.stringify({
                type: 'kick',
                data: {
                    player_id: playerId,
                    target_id: targetId
                }
            }));
        }

        function addEliminatedChatSection(gameContent, data) {
            // æ£€æŸ¥å½“å‰ç©å®¶æ˜¯å¦å·²è¢«æ·˜æ±°
            const currentPlayer = data.players.find(p => p.id === playerId);
            if (currentPlayer && !currentPlayer.is_alive) {
                const eliminatedChatDiv = document.createElement('div');
                eliminatedChatDiv.id = 'eliminatedChatSection';
                eliminatedChatDiv.innerHTML = `
                    <h3 style="margin-top: 20px; color: #dc3545;">è¢«æ·˜æ±°ç©å®¶èŠå¤©åŒºåŸŸ</h3>
                    <p style="color: #6c757d; font-size: 14px;">åªæœ‰è¢«æ·˜æ±°çš„ç©å®¶å¯ä»¥åœ¨æ­¤èŠå¤©</p>
                    <div id="eliminatedChatMessages" style="height: 150px; overflow-y: auto; border: 1px solid var(--chat-border); padding: 10px; margin-bottom: 10px;"></div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="eliminatedChatInput" placeholder="è¾“å…¥èŠå¤©å†…å®¹..." style="flex: 1;">
                        <button onclick="sendEliminatedChat()">å‘é€</button>
                    </div>
                `;
                gameContent.appendChild(eliminatedChatDiv);
                
                // æ˜¾ç¤ºå†å²è¢«æ·˜æ±°èŠå¤©æ¶ˆæ¯
                if (data.eliminated_chat_messages) {
                    showEliminatedChatMessages(data.eliminated_chat_messages);
                }
            }
        }
    </script>
</body>
</html> 